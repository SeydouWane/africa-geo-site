{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto py-10 px-4">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <nav class="flex items-center gap-2 text-sm">
            <a href="/" class="text-slate-500 hover:text-primary transition">Accueil</a>
            <i class="fas fa-chevron-right text-[10px] text-slate-400"></i>
            <span class="text-slate-900 font-bold">Explorateur : {{ country.name }}</span>
        </nav>
        
        <div class="relative group">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                <i class="fas fa-search group-focus-within:text-indigo-500"></i>
            </span>
            <input type="text" id="searchBox" placeholder="Rechercher une commune..." 
                   class="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-full text-sm w-full md:w-80 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all shadow-sm">
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8 sticky top-24">
                <div class="flex items-center gap-5 mb-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex items-center justify-center text-4xl font-black shadow-xl shadow-indigo-100 uppercase">
                        {{ country.iso }}
                    </div>
                    <div>
                        <h1 class="text-3xl font-black text-slate-900 leading-tight">{{ country.name }}</h1>
                        <p class="text-xs font-bold text-indigo-500 uppercase tracking-widest mt-1 italic">ID: {{ country.id }}</p>
                    </div>
                </div>

                <div class="space-y-4 mb-8">
                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                        <span class="text-sm font-medium text-slate-500">Régions enregistrées</span>
                        <span class="px-3 py-1 bg-white text-indigo-600 rounded-lg font-black shadow-sm">{{ country.hierarchy|length }}</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Documentation rapide</p>
                    <div class="p-4 bg-slate-900 rounded-2xl overflow-hidden relative">
                        <code class="text-indigo-400 text-[11px] font-mono break-all">GET /countries/{{ country.id }}/full-tree</code>
                        <button onclick="copyApiUrl()" class="absolute right-2 top-2 text-slate-500 hover:text-white transition">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <p class="text-[11px] text-slate-500 italic px-1 leading-relaxed">
                        <i class="fas fa-info-circle mr-1"></i> Idéal pour générer des JSON dynamiques pour vos formulaires de livraison ou d'inscription.
                    </p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div class="space-y-4" id="hierarchyContainer">
                {% for region in country.hierarchy %}
                <div class="region-card bg-white border border-slate-200 rounded-3xl shadow-sm hover:shadow-md transition-shadow overflow-hidden" data-name="{{ region.name|lower }}">
                    <button onclick="toggleAccordion('region-{{ loop.index }}')" class="w-full flex items-center justify-between p-6 text-left hover:bg-slate-50 transition">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-extrabold text-slate-800">{{ region.name }}</h3>
                                <p class="text-xs text-slate-400">{{ region.departments|length }} Départements / Cercles</p>
                            </div>
                        </div>
                        <i id="icon-region-{{ loop.index }}" class="fas fa-chevron-down text-slate-300 transition-transform"></i>
                    </button>

                    <div id="region-{{ loop.index }}" class="hidden border-t border-slate-100 bg-white">
                        <div class="p-6 space-y-6">
                            {% for dept in region.departments %}
                            <div class="dept-group relative pl-6 before:content-[''] before:absolute before:left-0 before:top-2 before:bottom-0 before:w-0.5 before:bg-indigo-100">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-sm font-black text-slate-700 uppercase tracking-wide">
                                        <i class="fas fa-folder-open text-amber-400 mr-2"></i>{{ dept.name }}
                                    </h4>
                                    <span class="text-[10px] font-mono text-slate-300">#{{ dept.id }}</span>
                                </div>
                                
                                <div class="flex flex-wrap gap-2">
                                    {% for com in dept.communes %}
                                    <div class="commune-tag group relative" data-name="{{ com.name|lower }}">
                                        <span class="inline-flex items-center bg-slate-50 border border-slate-200 px-3 py-1.5 rounded-xl text-xs font-semibold text-slate-600 group-hover:bg-indigo-600 group-hover:text-white group-hover:border-indigo-600 transition-all cursor-default">
                                            {{ com.name }}
                                            {% if com.latitude %}
                                            <i class="fas fa-location-dot ml-2 text-[10px] opacity-40 group-hover:opacity-100"></i>
                                            {% endif %}
                                        </span>
                                        
                                        {% if com.latitude %}
                                        <div class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max bg-slate-900 text-white text-[10px] px-3 py-1.5 rounded-lg shadow-xl z-20">
                                            GPS: {{ com.latitude }}, {{ com.longitude }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div id="noResults" class="hidden text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200">
                <i class="fas fa-search text-4xl text-slate-200 mb-4"></i>
                <p class="text-slate-500 font-medium">Aucune commune ne correspond à votre recherche.</p>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Accordéons
    function toggleAccordion(id) {
        const content = document.getElementById(id);
        const icon = document.getElementById('icon-' + id);
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    }

    // 2. Recherche en temps réel (Performante)
    document.getElementById('searchBox').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        const regions = document.querySelectorAll('.region-card');
        let totalVisible = 0;

        regions.forEach(region => {
            const communes = region.querySelectorAll('.commune-tag');
            let regionHasMatch = false;

            communes.forEach(com => {
                const name = com.getAttribute('data-name');
                if (name.includes(term)) {
                    com.classList.remove('hidden');
                    regionHasMatch = true;
                } else {
                    com.classList.add('hidden');
                }
            });

            if (regionHasMatch || term === "") {
                region.classList.remove('hidden');
                totalVisible++;
                // Ouvrir automatiquement la région si on cherche quelque chose
                if (term !== "") {
                    region.querySelector('div[id^="region-"]').classList.remove('hidden');
                }
            } else {
                region.classList.add('hidden');
            }
        });

        document.getElementById('noResults').classList.toggle('hidden', totalVisible > 0);
    });

    // 3. Copie API
    function copyApiUrl() {
        const url = "https://africa-geo-api.onrender.com/countries/{{ country.id }}/full-tree";
        navigator.clipboard.writeText(url).then(() => {
            alert("URL de l'API copiée dans le presse-papier !");
        });
    }
</script>

<style>
    .rotate-180 { transform: rotate(180deg); }
    .region-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
</style>
{% endblock %}